# ğŸ“š Message Queue

---

## 1. ì£¼ì œ/í‚¤ì›Œë“œ
- ë©”ì‹œì§€ íì™€ Kafkaì— ëŒ€í•´ ì•Œì•„ë³´ì!! (à¸‡ğŸ”¥â€¿ğŸ”¥)à¸‡

## ğŸ“‘ ëª©ì°¨

- [ğŸ“š Message Queue](#-message-queue)
  - [1. ì£¼ì œ/í‚¤ì›Œë“œ](#1-ì£¼ì œí‚¤ì›Œë“œ)
  - [ğŸ“‘ ëª©ì°¨](#-ëª©ì°¨)
  - [2. í•µì‹¬ ìš”ì•½ (Summary)](#2-í•µì‹¬-ìš”ì•½-summary)
    - [Message Queue (ë©”ì‹œì§€ í)](#message-queue-ë©”ì‹œì§€-í)
    - [Message Queueì˜ ì¥ì ](#message-queueì˜-ì¥ì )
    - [ë©”ì‹œì§€ ì „ì†¡ ë³´ì¥ ë°©ì‹](#ë©”ì‹œì§€-ì „ì†¡-ë³´ì¥-ë°©ì‹)
    - [Message Queue ì‚¬ìš© ì‹œ ê³ ë¯¼í•œ ì ](#message-queue-ì‚¬ìš©-ì‹œ-ê³ ë¯¼í•œ-ì )
      - [ìˆœì„œ ë³´ì¥ (Ordering)](#ìˆœì„œ-ë³´ì¥-ordering)
      - [ì¤‘ë³µ ì²˜ë¦¬ (Duplicate Handling)](#ì¤‘ë³µ-ì²˜ë¦¬-duplicate-handling)
      - [ì¥ì•  ëŒ€ì‘ (Failure Handling)](#ì¥ì• -ëŒ€ì‘-failure-handling)
      - [ë°±í”„ë ˆì…” (Backpressure)](#ë°±í”„ë ˆì…”-backpressure)
    - [Kafka (ë¶„ì‚° ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¬ë° í”Œë«í¼)](#kafka-ë¶„ì‚°-ë©”ì‹œì§€-ìŠ¤íŠ¸ë¦¬ë°-í”Œë«í¼)
    - [Kafkaì˜ êµ¬ì¡°](#kafkaì˜-êµ¬ì¡°)
    - [Kafkaì˜ íŠ¹ì§•](#kafkaì˜-íŠ¹ì§•)
    - [Kafka ë©”ì„¸ì§€ ì²˜ë¦¬ íë¦„](#kafka-ë©”ì„¸ì§€-ì²˜ë¦¬-íë¦„)
      - [Offset Commit ë°©ì‹](#offset-commit-ë°©ì‹)
    - [Idempotent Producer / Idempotent Consumer](#idempotent-producer--idempotent-consumer)
    - [Kafka ì‚¬ìš© ì‹œ ê³ ë¯¼í•œ ì ](#kafka-ì‚¬ìš©-ì‹œ-ê³ ë¯¼í•œ-ì )
      - [ë©”ì‹œì§€ ìˆœì„œ](#ë©”ì‹œì§€-ìˆœì„œ)
      - [Exactly-once (ì •í™•íˆ í•œë²ˆë§Œ)](#exactly-once-ì •í™•íˆ-í•œë²ˆë§Œ)
      - [ë°±í”„ë ˆì…” (Lag ë¬¸ì œ)](#ë°±í”„ë ˆì…”-lag-ë¬¸ì œ)
      - [ì¥ì•  ëŒ€ì‘](#ì¥ì• -ëŒ€ì‘)
      - [ë°ì´í„° ì •í•©ì„± (Commit ì‹œì )](#ë°ì´í„°-ì •í•©ì„±-commit-ì‹œì )
    - [Message Queue + Batch](#message-queue--batch)
    - [Message Queue + Batch + Scheduler](#message-queue--batch--scheduler)
  - [3. ì°¸ê³ /ì¶”ê°€ ìë£Œ (References)](#3-ì°¸ê³ ì¶”ê°€-ìë£Œ-references)
  - [4. ë‚´ì¼/ë‹¤ìŒì— ë³¼ ê²ƒ (Next Steps)](#4-ë‚´ì¼ë‹¤ìŒì—-ë³¼-ê²ƒ-next-steps)

---

## 2. í•µì‹¬ ìš”ì•½ (Summary)

### Message Queue (ë©”ì‹œì§€ í)
- **ë¹„ë™ê¸° í†µì‹ **ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” **ì¤‘ê°„ ì €ì¥ì†Œ**
- í”„ë¡œë“€ì„œ(Producer)ê°€ ë©”ì‹œì§€ë¥¼ ë„£ê³ , ì»¨ìŠˆë¨¸(Consumer)ê°€ ë©”ì‹œì§€ë¥¼ êº¼ë‚´ ì²˜ë¦¬
- ëŒ€í‘œ ê¸°ìˆ : RabbitMQ, Kafka, SQS, Redis Streams
- ëª©ì : **ì‹œìŠ¤í…œ ê°„ ê²°í•©ë„ ë‚®ì¶”ê¸° + íŠ¸ë˜í”½ ë¶„ì‚° ì²˜ë¦¬**

---

### Message Queueì˜ ì¥ì 
- **ë¹„ë™ê¸° ì²˜ë¦¬**
  - ìš”ì²­ ì¦‰ì‹œ ì‘ë‹µí•˜ê³ , **ì‹¤ì œ ì‘ì—…ì€ íì— ë„£ì–´ ë‚˜ì¤‘ì— ì²˜ë¦¬**
  - ì˜ˆ: ì´ë©”ì¼/SMS ë°œì†¡, ë¡œê·¸ ì €ì¥
- **ë²„í¼ ì—­í• **
  - íŠ¸ë˜í”½ ê¸‰ì¦ ì‹œ, íê°€ ë²„í¼ ì—­í• 
- **ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ ë‚®ì¶¤**
  - ìƒì‚°ì, ì†Œë¹„ìê°€ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•Šê³ , ë©”ì‹œì§€ íë¥¼ ì‚¬ì´ì— ë‘ 
- **í™•ì¥ì„±**
  - ì»¨ìŠˆë¨¸ë¥¼ ìˆ˜í‰ í™•ì¥(scale-out)í•´ì„œ ì²˜ë¦¬ëŸ‰ ëŠ˜ë¦¼

---

### ë©”ì‹œì§€ ì „ì†¡ ë³´ì¥ ë°©ì‹
- **At-most once** (ìµœëŒ€ í•œ ë²ˆë§Œ)
  - ë©”ì‹œì§€ê°€ ìœ ì‹¤ë  ìˆ˜ ìˆìŒ, ì¤‘ë³µì€ ì—†ìŒ
- **At-least once** (ìµœì†Œ í•œ ë²ˆë§Œ)
  - ìœ ì‹¤ì€ ì—†ì§€ë§Œ, ì¤‘ë³µ ê°€ëŠ¥ -> ë³´í†µ ì´ ë°©ì‹ì„ ê¸°ë³¸ìœ¼ë¡œ í•¨
- **Exactly once** (ì •í™•íˆ í•œ ë²ˆ)
  - í•œ ë²ˆë§Œ, ë¹ ì§ì—†ì´, ì¤‘ë³µ ì—†ì´ ì²˜ë¦¬
  - ìœ ì‹¤ë„, ì¤‘ë³µë„ ì—†ìŒ (êµ¬í˜„ ë³µì¡, ì„±ëŠ¥ ë¹„ìš© í¼)
  - Kafka + íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ í†µí•´ ì§€ì› ê°€ëŠ¥
  - ì´ë¥¼ ë³´ì¥í•˜ë ¤ë©´ Producer, Broker, Consumer, DB ëª¨ë‘ì—ì„œ ì •í•©ì„±ì„ ë§ì¶°ì•¼ í•¨
- ë³´í†µ ë©”ì„¸ì§€ í(kafka)ë¥¼ ì‚¬ìš©í•  ë•Œ ì´ 3ë¶€ë¶„ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•¨
  - Producer -> Broker êµ¬ê°„: ë„¤íŠ¸ì›Œí¬ ì§€ì—°/Retry ë•Œë¬¸ì— ë©”ì‹œì§€ê°€ ì¤‘ë³µ ê¸°ë¡ë  ìˆ˜ ìˆìŒ
  - Broker -> Consumer êµ¬ê°„: Consumerê°€ ë©”ì‹œì§€ ë°›ì•˜ì§€ë§Œ ì²˜ë¦¬ ì¤‘ ì£½ìœ¼ë©´ -> ë‹¤ì‹œ ê°™ì€ ë©”ì‹œì§€ë¥¼ ë°›ìŒ (ì¤‘ë³µ)
  - Consumer -> DB ì²˜ë¦¬ êµ¬ê°„: DB insert ì¤‘ ì‹¤íŒ¨í•´ì„œ Retry í•˜ë©´ ì¤‘ë³µ insert ê°€ëŠ¥
- ì—¬ê¸°ì„œ ì ê¹! 
- Brokerë€?
  - ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³  ì „ë‹¬í•˜ëŠ” ì„œë²„
  - Kafkaì—ì„œëŠ” í•˜ë‚˜ì˜ Broker = í•˜ë‚˜ì˜ Kafka ì„œë²„ í”„ë¡œì„¸ìŠ¤
  - Producer -> ë©”ì‹œì§€ë¥¼ Brokerì— ì „ì†¡ -> Brokerê°€ ë””ìŠ¤í¬ì— ì €ì¥ -> Consumerê°€ Brokerì—ì„œ ì½ì–´ê°

---

### Message Queue ì‚¬ìš© ì‹œ ê³ ë¯¼í•œ ì 
- ë©”ì„¸ì§€í(Kafka) ë„ì…ì„ ìœ„í•´ ê³ ë¯¼í•œ ë¶€ë¶„ ì •ë¦¬í•˜ëŠ” ì¤‘~~

#### ìˆœì„œ ë³´ì¥ (Ordering)
- ë©”ì‹œì§€ íëŠ” ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë  ê±°ì•¼~~ ë¼ê³  ìƒê°í•˜ê¸° ì‰½ì§€ë§Œ, ì‹¤ì œë¡œëŠ” **ë¬´ì¡°ê±´ ìˆœì„œ ë³´ì¥ì„ í•˜ëŠ” ê²ƒì€ ì•„ë‹˜**
- ì˜ˆë¥¼ ë“¤ì–´
  - KafkaëŠ” **íŒŒí‹°ì…˜ ë‹¨ìœ„**ë¡œë§Œ ìˆœì„œë¥¼ ë³´ì¥
  - RabbitMQëŠ” **Queue ë‹¨ì¼ consumer**ì¼ ë•Œë§Œ ìˆœì„œ ë³´ì¥
- ë¬¸ì œ ìƒí™©
  - ì˜ˆë¥¼ ë“¤ì–´ **ì”ì•¡ ì°¨ê° -> ê±°ë˜ ì™„ë£Œ ê¸°ë¡** ì´ë²¤íŠ¸ê°€ ìˆëŠ”ë° ìˆœì„œê°€ ë°”ë€Œë©´? -> ë°ì´í„° ì •í•©ì„± ê¹¨ì§
- í•´ê²° ë°©ë²•
  - Kafkaì—ì„œëŠ” **Key ê¸°ë°˜ íŒŒí‹°ì…”ë‹** ì‚¬ìš© -> ê°™ì€ key(ì˜ˆ: ê°™ì€ ì‚¬ìš©ì ID)ì˜ ì´ë²¤íŠ¸ëŠ” ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ë“¤ì–´ê°€ì„œ ìˆœì„œ ìœ ì§€
  - ì „ì²´ ìˆœì„œ ë³´ì¥ì´ í•„ìš”í•œ ê²½ìš°? -> ë‹¨ì¼ íŒŒí‹°ì…˜ë§Œ ì“°ê¸° (í•˜ì§€ë§Œ ì„±ëŠ¥ í™•ì¥ì„±ì€ ë‚®ì•„ì§)
  - ë”°ë¼ì„œ ë‚´ê°€ ìˆœì„œë¥¼ ì–¼ë§ˆë‚˜ ê°•í•˜ê²Œ ë³´ì¥í•´ì•¼ í•˜ì§€? ì— ë”°ë¼ ê²°ì •í•´ì•¼ í•¨
  - ë’¤ì— ë” ìì„¸íˆ ì„¤ëª…!

---

#### ì¤‘ë³µ ì²˜ë¦¬ (Duplicate Handling)
- MQëŠ” ë³´í†µ **At-least-once**ë¥¼ ë³´ì¥ -> ë©”ì‹œì§€ê°€ ì¤‘ë³µ ì†Œë¹„ë  ìˆ˜ ìˆìŒ
- ë¬¸ì œ ìƒí™©
  - DB Insert ë‘ ë²ˆ -> ì¤‘ë³µ ë°ì´í„° ë°œìƒ
  - ê²°ì œ ì´ë²¤íŠ¸ ë‘ ë²ˆ -> ëˆ ë‘ ë²ˆ ë¹ ì§(ì•ˆë¼~~)
- í•´ê²° ë°©ë²•
  - **Idempotent Consumer** ì„¤ê³„ (ë©±ë“±ì„± ê³ ë ¤)
    - ë©”ì‹œì§€ ID ê¸°ë°˜ìœ¼ë¡œ **ì´ë¯¸ ì²˜ë¦¬í•œ ë©”ì‹œì§€ì¸ì§€ ì²´í¬** (ex. Redisë‚˜ DBì— processed flag ì €ì¥)
    - DBì—ì„œ `INSERT` ëŒ€ì‹  `UPSERT`(ì¤‘ë³µ ì‹œ update) ì‚¬ìš©
    - ê²°ì œ/ì†¡ê¸ˆ ê°™ì€ ê°•í•œ ì •í•©ì„±ì´ í•„ìš”í•œ ê²½ìš° -> DB íŠ¸ëœì­ì…˜, unique key constraint í™œìš©

---

#### ì¥ì•  ëŒ€ì‘ (Failure Handling)
- ë¬¸ì œ ìƒí™©
  - Consumerê°€ ì£½ìœ¼ë©´? -> ë©”ì‹œì§€ ì•ˆ ì½í˜
  - Brokerê°€ ì£½ìœ¼ë©´? -> ë°ì´í„° ìœ ì‹¤ ìœ„í—˜
  - ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨í•˜ë©´? -> ë¬´í•œ ì¬ì‹œë„? Dead Letter Queue?
- í•´ê²° ë°©ë²•
  - Consumer ì¥ì• 
    - Consumer Groupì„ í™œìš© -> ê°™ì€ ê·¸ë£¹ ë‚´ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì´ì–´ë°›ìŒ (auto rebalance)
  - Broker ì¥ì• 
    - KafkaëŠ” Replication Factor â‰¥ 3 ê¶Œì¥ -> í•˜ë‚˜ ì£½ì–´ë„ ë‚˜ë¨¸ì§€ë¡œ ë³µêµ¬
    - í•˜ì§€ë§Œ failover ì¤‘ì—” ì ê¹ì˜ ì“°ê¸° ë¶ˆê°€ ìƒíƒœ ë°œìƒ ê°€ëŠ¥ -> ì´ê±° ê°ì•ˆí•˜ê³  ì„¤ê³„ í•„ìš”
  - ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨
    - ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ -> DLQ (Dead Letter Queue)ì— ë„£ì–´ ë¶„ì„/ì¬ì²˜ë¦¬
    - DLQ: ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ ëª»í•œ ë©”ì‹œì§€ë¥¼ ë”°ë¡œ ëª¨ì•„ë‘ëŠ” í(ì¥ì•  ì²˜ë¦¬)
  - Fallback
    - ë©”ì‹œì§€í ì¥ì•  ì‹œ DB ì„ì‹œ ê¸°ë¡ í›„ ë‚˜ì¤‘ì— batch ì¬ì²˜ë¦¬
    - ë‹¨, DB ë¶€í•˜ í­ì¦ ê°€ëŠ¥ -> ì¤‘ìš”ë„ ë‚®ì€ ê¸°ëŠ¥ì€ **Graceful Degradation**ìœ¼ë¡œ ë©ˆì¶”ëŠ” ê²ƒë„ ê³ ë ¤

---

#### ë°±í”„ë ˆì…” (Backpressure)
- íì— ë©”ì‹œì§€ê°€ ìŒ“ì´ëŠ”ë° ì†Œë¹„ ì†ë„ê°€ ëª» ë”°ë¼ê°€ëŠ” ìƒí™©
- ë¬¸ì œ ìƒí™©
  - Kafkaì— ë©”ì‹œì§€ëŠ” ìŒ“ì´ëŠ”ë° consumer ì²˜ë¦¬ ì†ë„ê°€ ëŠë¦¬ë©´ â†’ **lag ì¦ê°€**
  - Lag: Producerê°€ ìŒ“ì€ ë©”ì‹œì§€ ê°œìˆ˜ - Consumerê°€ ì²˜ë¦¬í•œ ë©”ì‹œì§€ ê°œìˆ˜
  - ì¼ì • ì´ìƒ ìŒ“ì´ë©´ ë””ìŠ¤í¬ í„°ì§ / ì²˜ë¦¬ ì§€ì—° -> ì¥ì•  ì „íŒŒ
- í•´ê²° ë°©ë²•
  - Consumer Scale-out: Consumer ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ ëŠ˜ë ¤ ë³‘ë ¬ ì²˜ë¦¬
  - Batch ì²˜ë¦¬: í•˜ë‚˜ì”© ë§ê³  ë¬¶ì–´ì„œ ì²˜ë¦¬
  - QoS(í’ˆì§ˆ ì œì–´)
    - ì¤‘ìš”ë„ ë‚®ì€ ë©”ì‹œì§€ëŠ” Drop
    - ìš°ì„ ìˆœìœ„ Queue ë¶„ë¦¬
  - Circuit Breaker
    - íŠ¹ì • consumerê°€ ê³¼ë¶€í•˜ ê±¸ë¦¬ë©´ ìš”ì²­ ì°¨ë‹¨/ì§€ì—°
  - Kafkaì˜ ê²½ìš° **Lag ëª¨ë‹ˆí„°ë§** (Prometheus + Grafana) í•„ìˆ˜

---

### Kafka (ë¶„ì‚° ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¬ë° í”Œë«í¼)
- ë‹¨ìˆœ ë©”ì‹œì§€íê°€ ì•„ë‹ˆë¼ **ëŒ€ê·œëª¨ ë¡œê·¸ ë° ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°** ì²˜ë¦¬ì— ìµœì í™”ëœ í”Œë«í¼
- LinkedInì—ì„œ ì‹œì‘ -> í˜„ì¬ ì—…ê³„ í‘œì¤€
- ì´ˆë‹¹ **ìˆ˜ë°±ë§Œ ê±´ ë©”ì‹œì§€ ì²˜ë¦¬ ê°€ëŠ¥**
- ë©”ì‹œì§€ë¥¼ **ë””ìŠ¤í¬**ì— ì €ì¥í•´ì„œ ì¬ì²˜ë¦¬ ê°€ëŠ¥ -> ë‹¨ìˆœ íì™€ í° ì°¨ì´ì 

---

### Kafkaì˜ êµ¬ì¡°
- Producer: ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ëŠ” ìª½
- Consumer: ë©”ì‹œì§€ë¥¼ êµ¬ë…í•˜ê³  ì²˜ë¦¬í•˜ëŠ” ìª½
- Topic: ë©”ì‹œì§€ë¥¼ ë¶„ë¥˜í•˜ëŠ” ë‹¨ìœ„ (ex. `order-events`) (ë©”ì‹œì§€ ì¢…ë¥˜ë³„ ì¹´í…Œê³ ë¦¬ ëŠë‚Œ)
- Partition: í† í”½ì„ ì—¬ëŸ¬ ì¡°ê°ìœ¼ë¡œ ë‚˜ëˆˆ ê²ƒ -> ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥
- Broker: Kafka ì„œë²„ (ë©”ì‹œì§€ë¥¼ ì €ì¥/ì „ì†¡)
- Zookeeper(or KRaft): í´ëŸ¬ìŠ¤í„° ë©”íƒ€ë°ì´í„° ê´€ë¦¬ (ìµœê·¼ì—” KRaftë¡œ ëŒ€ì²´ ì¶”ì„¸?)
- Offset: ë©”ì‹œì§€ ìœ„ì¹˜ í‘œì‹œ (ì†Œë¹„ìê°€ ì–´ë””ê¹Œì§€ ì½ì—ˆëŠ”ì§€ ì¶”ì )

---

### Kafkaì˜ íŠ¹ì§•
- ê³ ì„±ëŠ¥
  - ë©”ì‹œì§€ë¥¼ í•˜ë‚˜ì”© ì“°ëŠ” ê²Œ ì•„ë‹ˆë¼, **ì—¬ëŸ¬ ê°œ ëª¨ì•„ì„œ(ë°°ì¹˜ ì²˜ë¦¬) ì”€**
  - ë””ìŠ¤í¬ì— ê¸°ë¡í•  ë•Œë„ ìˆœì°¨ì ìœ¼ë¡œ ì­‰~ ì“°ê¸°
- í™•ì¥ì„±
  - í† í”½ì„ íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ëˆ ì„œ **ì—¬ëŸ¬ Consumerê°€ ë³‘ë ¬**ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
  - Broker(ì„œë²„) ê°œìˆ˜ë¥¼ ëŠ˜ë¦¬ë©´ ì²˜ë¦¬ëŸ‰ë„ ê°™ì´ í™•ì¥ë¨
- ë‚´êµ¬ì„±
  - ë©”ì‹œì§€ë¥¼ ë©”ëª¨ë¦¬ì—ë§Œ ë‘ëŠ” ê²Œ ì•„ë‹ˆë¼ **ë””ìŠ¤í¬ì— ì €ì¥**
  - ì—¬ëŸ¬ Brokerì— ë³µì œ(Replication) í•´ì„œ í•œ ëŒ€ê°€ ì£½ì–´ë„ ë°ì´í„° ì•ˆì „
- Consumer Group
  - Consumer ì—¬ëŸ¬ ê°œë¥¼ í•˜ë‚˜ì˜ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìœ¼ë©´ -> íŒŒí‹°ì…˜ì„ ë‚˜ëˆ ì„œ ê°ê° ì²˜ë¦¬
  - í•œ ê·¸ë£¹ ì•ˆì—ì„œëŠ” ì¤‘ë³µ ì²˜ë¦¬ ì—†ìŒ (íŒŒí‹°ì…˜ í•˜ë‚˜ = Consumer í•˜ë‚˜ ì „ë‹´)
- ì¬ì²˜ë¦¬ ê°€ëŠ¥
  - ë©”ì‹œì§€ë¥¼ ì–´ë””ê¹Œì§€ ì½ì—ˆëŠ”ì§€ offsetìœ¼ë¡œ ê¸°ë¡
  - offsetì„ ë˜ëŒë¦¬ë©´, **ì´ì „ ë©”ì‹œì§€ë¥¼ ë‹¤ì‹œ ì½ì–´ì„œ ì¬ì²˜ë¦¬** ê°€ëŠ¥
  - ì¥ì•  ë³µêµ¬, ë°ì´í„° ë¶„ì„í•  ë•Œ ìœ ìš©

---

### Kafka ë©”ì„¸ì§€ ì²˜ë¦¬ íë¦„
- Producer
  - ë©”ì‹œì§€ë¥¼ íŠ¹ì • Topicì— ë°œí–‰
  - Key í•´ì‹œê°’ìœ¼ë¡œ Partition ì„ íƒ -> ê°™ì€ KeyëŠ” ê°™ì€ Partition(ìˆœì„œ ë³´ì¥)
- Broker
  - ë©”ì‹œì§€ë¥¼ ë””ìŠ¤í¬(Log)ì— ìˆœì°¨ ì €ì¥
  - ê° ë©”ì‹œì§€ëŠ” Offsetìœ¼ë¡œ êµ¬ë¶„
  - Leader-Follower êµ¬ì¡°ë¡œ ë³µì œí•˜ì—¬ ì¥ì•  ëŒ€ë¹„
- Consumer
  - Topic êµ¬ë… í›„ ë©”ì‹œì§€ ì½ìŒ
  - Consumer Group ë‹¨ìœ„ë¡œ íŒŒí‹°ì…˜ì„ ë‚˜ëˆ  ë³‘ë ¬ ì²˜ë¦¬
  - ì²˜ë¦¬ ì™„ë£Œ í›„ Offset Commit -> ë‹¤ìŒë²ˆ ì´ì–´ì„œ ì²˜ë¦¬

--- 

#### Offset Commit ë°©ì‹
- **Auto Commit** (ê¸°ë³¸ê°’)
  - ì£¼ê¸°ì ìœ¼ë¡œ ìë™ commit (ì˜ˆ: 5ì´ˆë§ˆë‹¤)
  - ì²˜ë¦¬ ì™„ë£Œ ì „ commit -> ë°ì´í„° ìœ ì‹¤ ê°€ëŠ¥
- **Manual Commit**
  - ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ í›„ì— ì§ì ‘ commit
  - ìœ ì‹¤ì€ ë§‰ì§€ë§Œ, ì¥ì•  ì‹œ ì¤‘ë³µ ë°œìƒ ê°€ëŠ¥
  - ë”°ë¼ì„œ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ Manual Commit + Idempotent Consumer ì¡°í•© ì‚¬ìš©
  - Idempotent Consumer: ê°™ì€ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ë°›ì•„ë„ ê²°ê³¼ê°€ í•œ ë²ˆ ì²˜ë¦¬í•œ ê²ƒê³¼ ê°™ê²Œ ë§Œë“œëŠ” ì»¨ìŠˆë¨¸

---

### Idempotent Producer / Idempotent Consumer
- Idempotent Producer
  - ê°™ì€ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ë³´ë‚´ë„ ë¸Œë¡œì»¤ì—ëŠ” í•œ ë²ˆë§Œ ê¸°ë¡ë˜ê²Œ í•¨
  - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜/ì¬ì‹œë„ë¡œ ì¤‘ë³µ ì „ì†¡ì´ ë°œìƒí•˜ì—¬ ë¸Œë¡œì»¤ì— ì¤‘ë³µ ë©”ì„¸ì§€ê°€ ìŒ“ì´ì§€ ì•Šë„ë¡ ì‚¬ìš©
  - Kafkaê°€ PID(Producer ID) + sequence numberë¡œ ì¤‘ë³µ ì‹ë³„í•˜ì—¬ ì¤‘ë³µ ê¸°ë¡ ë“œë¡­
  - ë‹¨ì 
    - ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ: Producerì™€ Broker ê°„ ì¶”ê°€ ë©”íƒ€ë°ì´í„°(ID ê´€ë¦¬ ë“±) ì²˜ë¦¬ í•„ìš”
    - Broker ì˜ì¡´ì„± ì¦ê°€: Broker ì¥ì•  ì‹œ, ì¤‘ë³µ ë³´ì¥ ë¬´ë„ˆì§ˆ ìˆ˜ ìˆìŒ
    - KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¨ì¼ íŒŒí‹°ì…˜ ë‚´ì—ì„œë§Œ ìˆœì„œ+Idempotent ë³´ì¥

- Idempotent Consumer
  - ê°™ì€ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ì½ì–´ë„ ì²˜ë¦¬ ê²°ê³¼ê°€ í•œ ë²ˆ ì²˜ë¦¬í•œ ê²ƒê³¼ ë™ì¼í•˜ê²Œ í•¨
  - KafkaëŠ” ê¸°ë³¸ì´ at-least-onceë¼ ì¤‘ë³µ ì†Œë¹„ ë°œìƒ ìœ„í—˜ì´ ìˆì–´ ì‚¬ìš©
  - **ê³ ìœ  ë©”ì‹œì§€ í‚¤ ê¸°ë°˜ ì¤‘ë³µ ë°©ì§€**
    - ë©”ì‹œì§€ì— eventId(ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤: orderId, paymentId) í¬í•¨
    - ì²˜ë¦¬ ì „ processed:eventId ì¡´ì¬ ì—¬ë¶€ í™•ì¸(ìºì‹œ/DB)
    - ì—†ìœ¼ë©´ ì²˜ë¦¬ í›„ ì²´í¬(set) / ìˆìœ¼ë©´ ìŠ¤í‚µ

---

### Kafka ì‚¬ìš© ì‹œ ê³ ë¯¼í•œ ì 
- MQ ê³ ë¯¼í•œ ì  ì—°ì¥ì„ ìœ¼ë¡œ ì¢€ ë” ê¸°ìˆ ì ì¸ ë‚´ìš©!
  
#### ë©”ì‹œì§€ ìˆœì„œ
  - KafkaëŠ” **í† í”½ ì „ì²´ ìˆœì„œëŠ” ë³´ì¥ ë¶ˆê°€**
  - íŒŒí‹°ì…˜ ë‹¨ìœ„ë¡œë§Œ ìˆœì„œë¥¼ ë³´ì¥ (ì •í™•íˆëŠ” íŒŒí‹°ì…˜ ë‚´ë¶€ ë©”ì„¸ì§€ë¼ë¦¬ë§Œ ìˆœì„œ ë³´ì¥)
  - Key hashingìœ¼ë¡œ ê°™ì€ í‚¤ëŠ” ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ê°€ê²Œ ì„¤ê³„í•´ì•¼ í•¨
  - ì „ì²´ ìˆœì„œ ì •ë ¬ì´ í•„ìš”í•˜ë‹¤ë©´? -> íŒŒí‹°ì…˜ 1ê°œë§Œ ë‘ê³  ìˆœì°¨ ì²˜ë¦¬

---

#### Exactly-once (ì •í™•íˆ í•œë²ˆë§Œ)
- KafkaëŠ” ì›ë˜ at-least-once -> ì¤‘ë³µ ê°€ëŠ¥
- Exactly-onceë¥¼ ë§Œë“¤ë ¤ë©´
  - Producerì—ì„œ **idempotent producer ì„¤ì •**
    - Producerê°€ ê°™ì€ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ë³´ë‚´ë”ë¼ë„ Brokerê°€ ì¤‘ë³µì„ ê±¸ëŸ¬ë‚´ê³  ë‹¨ í•œ ë²ˆë§Œ ì €ì¥í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” ì„¤ì •
  - Consumerì—ì„œ ì²˜ë¦¬ í›„ -> ì»¤ë°‹
  - Consumer + DBë¥¼ ë¬¶ëŠ” íŠ¸ëœì­ì…˜ í•„ìš” -> Kafka Transaction API í™œìš©
  - í•˜ì§€ë§Œ ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œê°€ ì‹¬í•´ì„œ ì„œë¹„ìŠ¤ì— ë”°ë¼ at-least-once + idempotent consumerë¡œ íƒ€í˜‘

---

#### ë°±í”„ë ˆì…” (Lag ë¬¸ì œ)
- Consumerê°€ ë©”ì‹œì§€ë¥¼ ëŠ¦ê²Œ ì²˜ë¦¬í•˜ë©´ -> Lagì´ ê³„ì† ìŒ“ì„
- Lagì´ ì»¤ì§€ë©´
  - ì‹¤ì‹œê°„ì„±ì´ ê¹¨ì§
  - Broker ë””ìŠ¤í¬ì— ë¶€í•˜
- í•´ê²° ë°©ë²•
  - Consumer ì¸ìŠ¤í„´ìŠ¤ ëŠ˜ë¦¬ê¸° (Group ë‚´ íŒŒí‹°ì…˜ ë¶„ë°°)
  - ë©”ì‹œì§€ ì²˜ë¦¬ ìµœì í™” (batch ì²˜ë¦¬, DB bulk insert)
  - ì¤‘ìš”ë„ ë‚®ì€ ë©”ì‹œì§€ëŠ” TTL ë‘ê³  ìë™ íê¸°

---

#### ì¥ì•  ëŒ€ì‘
- **Consumer ì¥ì• **
  - ë™ì¼ ê·¸ë£¹ ë‚´ ë‹¤ë¥¸ Consumerê°€ ì´ì–´ë°›ìŒ (Rebalance)
  - ë¬¸ì œ: Rebalance ë™ì•ˆ ì²˜ë¦¬ ì§€ì—° ë°œìƒ
- **Broker ì¥ì• **
  - Replicationìœ¼ë¡œ ë³µêµ¬ ê°€ëŠ¥
  - ìƒˆë¡œìš´ Leader ìŠ¹ê²© í•˜ëŠ” ë™ì•ˆ ë©”ì‹œì§€ ì „ì†¡ ë¶ˆê°€ -> ë³µêµ¬ í›„ í´ë¼ì´ì–¸íŠ¸ Retry í•„ìš”(ìì²´ Retry ë©”ì»¤ë‹ˆì¦˜ì´ ì¡´ì¬)
    - ê° Topic-Partitionì—ëŠ” Leader Brokerê°€ ìˆìŒ -> Producer/ConsumerëŠ” Leaderë‘ë§Œ í†µì‹ í•¨
    - Leaderê°€ ì£½ìœ¼ë©´, Follower ì¤‘ í•˜ë‚˜ë¥¼ Leaderë¡œ ìŠ¹ê²©í•´ì•¼ í•¨ -> ì´ë•Œ Controller Brokerê°€ ì„ ì¶œ ì ˆì°¨ë¥¼ ê´€ë¦¬í•¨
- **ë„¤íŠ¸ì›Œí¬ ì¥ì• **
  - Producer ACK ì˜µì…˜ (`acks=0,1,all`)
  - `acks=all` ì„¤ì •í•˜ë©´ ì•ˆì „í•˜ì§€ë§Œ ì„±ëŠ¥ ì €í•˜
  - acks=0 ë¹ ë¥´ì§€ë§Œ ìœ ì‹¤ ìœ„í—˜ / acks=1 ê¸°ë³¸ê°’, ìœ ì‹¤ ê°€ëŠ¥ / acks=all ìœ ì‹¤ ë°©ì§€,ì„±ëŠ¥ ë‚®ì•„ì§

---

#### ë°ì´í„° ì •í•©ì„± (Commit ì‹œì )
- KafkaëŠ” **ë©”ì‹œì§€ ì½ê³  ë‚˜ì„œ ìˆ˜ë™ ì»¤ë°‹/ìë™ ì»¤ë°‹** ê°€ëŠ¥
  - **ì²˜ë¦¬ ì„±ê³µ ì „ ì»¤ë°‹** -> ìœ ì‹¤ ìœ„í—˜
  - **ì²˜ë¦¬ í›„ ì»¤ë°‹** -> ì¤‘ë³µ ìœ„í—˜
- ë”°ë¼ì„œ ì²˜ë¦¬ í›„ ì»¤ë°‹ + idempotent consumerë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì–´

---

### Message Queue + Batch
- ë©”ì‹œì§€ í(MQ)
  - ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ëŠ” ì¦‰ì‹œ â†’ Consumerê°€ ì½ì–´ ì²˜ë¦¬ (**ì‹¤ì‹œê°„ì„±**)
  - ì˜ˆ: ì£¼ë¬¸ ë°œìƒ ì‹œ ë°”ë¡œ ì•Œë¦¼ ë°œì†¡, ì¬ê³  ì°¨ê°
- ë°°ì¹˜(Batch)
  - ë°ì´í„°ë¥¼ ëª¨ì•„ë‘ì—ˆë‹¤ê°€ ì¼ì • ì‹œê°„/ì£¼ê¸°ë§ˆë‹¤ í•œ ë²ˆì— ì²˜ë¦¬ (**ì¼ê´„ì„±**)
  - ì˜ˆ: í•˜ë£¨ ë™ì•ˆ ëª¨ì¸ ê±°ë˜ ë‚´ì—­ -> ìì •ì— ì •ì‚°
- ê°™ì´ ì“°ëŠ” ì´ìœ 
  - **ì‹¤ì‹œê°„ ì²˜ë¦¬ + ì¬ì²˜ë¦¬**
    - MQ: ì´ë²¤íŠ¸ ì¦‰ì‹œ ì²˜ë¦¬ (ì•Œë¦¼, ë¡œê·¸ ì ì¬)
    - Batch: í˜¹ì‹œ MQì—ì„œ ì‹¤íŒ¨í•˜ê±°ë‚˜ ëˆ„ë½ëœ ë©”ì‹œì§€ ìˆìœ¼ë©´ ë‹¤ì‹œ ì¬ì²˜ë¦¬
  - **ë¹ ë¥¸ ì‘ë‹µ + ë¬´ê±°ìš´ ì‘ì—… ë¶„ë¦¬**
    - MQ: ìš”ì²­ ì¦‰ì‹œ íì— ë„£ê³  ë¹ ë¥¸ ì‘ë‹µ -> ê°€ìš©ì„± ë†’ìŒ
    - Batch: íì— ìŒ“ì¸ ë©”ì‹œì§€ë¥¼ ì¼ì •ëŸ‰ ëª¨ì•„ì„œ DB Bulk Insert -> ì„±ëŠ¥ ìµœì í™”
  - **ì •í•©ì„± ë³´ì™„**
    - MQë§Œ ì“°ë©´ ì¥ì• ë¡œ ë©”ì‹œì§€ ì¼ë¶€ ìœ ì‹¤ ê°€ëŠ¥
    - Batchë¥¼ ëŒë ¤ì„œ ì˜ˆì „ ë°ì´ì„œë¥¼ ë‹¤ì‹œ ë§ì¶°ì£¼ë©´ ì •í•©ì„± ì§€í‚¬ ìˆ˜ ìˆìŒ
- ê·¸ëŸ¼ ê°™ì´ ì“°ëŠ” ìƒí™©ì„ ê³ ë¯¼í•´ë³´ì~
- ì˜¨ë¼ì¸ ì£¼ë¬¸ ì‹œìŠ¤í…œ
  - ì‚¬ìš©ìê°€ ì£¼ë¬¸ -> MQì— â€œorder_createdâ€ ì´ë²¤íŠ¸ ë°œí–‰
  - Consumerê°€ ë°”ë¡œ ì½ê³  **ì•Œë¦¼ ë°œì†¡, ì¬ê³  ì°¨ê°** (ì‹¤ì‹œê°„ ì²˜ë¦¬)
  - ë™ì‹œì— ì´ë²¤íŠ¸ ë¡œê·¸ëŠ” Kafkaì— ê³„ì† ìŒ“ì„
  - ìì •ë§ˆë‹¤ Batchê°€ Kafka ë¡œê·¸ë¥¼ ì½ì–´ì„œ **ì¼ë³„ ë§¤ì¶œ ì§‘ê³„, ì •ì‚° ì²˜ë¦¬, ëˆ„ë½ëœ ì´ë²¤íŠ¸ ì¬ê²€ì¦** ë“±ì„ ì‹¤í–‰í•¨
- ê¸°ìˆ ì ìœ¼ë¡œ ê³ ë¯¼í•  ì 
  - **ì¤‘ë³µ ì²˜ë¦¬**
    - MQì™€ Batchê°€ ê°™ì€ ë°ì´í„°ë¥¼ ë‘ ë²ˆ ë°˜ì˜í•  ìˆ˜ë„ ìˆìŒ -> Idempotent ì„¤ê³„ í•„ìš”
  - **ë°ì´í„° ì •í•©ì„±**
    - MQëŠ” ì¦‰ì‹œ ë°˜ì˜, BatchëŠ” ë‚˜ì¤‘ ë°˜ì˜ -> íƒ€ì´ë°ì— ë”°ë¼ ê°’ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ

---

### Message Queue + Batch + Scheduler
- ë©”ì‹œì§€ í(MQ)
  - ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ëŠ” ì¦‰ì‹œ â†’ Consumerê°€ ì½ì–´ ì²˜ë¦¬ (**ì‹¤ì‹œê°„ì„±**)
  - ì˜ˆ: ì£¼ë¬¸ ë°œìƒ ì‹œ ë°”ë¡œ ì•Œë¦¼ ë°œì†¡, ì¬ê³  ì°¨ê°
- ë°°ì¹˜(Batch)
  - ë°ì´í„°ë¥¼ ëª¨ì•„ë‘ì—ˆë‹¤ê°€ ì¼ì • ì‹œê°„/ì£¼ê¸°ë§ˆë‹¤ í•œ ë²ˆì— ì²˜ë¦¬ (**ì¼ê´„ì„±**)
  - ì˜ˆ: í•˜ë£¨ ë™ì•ˆ ëª¨ì¸ ê±°ë˜ ë‚´ì—­ -> ìì •ì— ì •ì‚°
- ìŠ¤ì¼€ì¤„ëŸ¬(Scheduler)**
  - ì–¸ì œ, ì–¼ë§ˆë‚˜ ìì£¼ ì‹¤í–‰í• ì§€ ì œì–´
  - ë°°ì¹˜ ì‹¤í–‰ íŠ¸ë¦¬ê±°, retry job ì‹¤í–‰
- ê·¸ëŸ¼ ì–´ë–»ê²Œ ê°™ì´ ì‚¬ìš©í• ê¹Œ?
  - ì´ë²¤íŠ¸ -> í -> ë°°ì¹˜
    - ì£¼ë¬¸ ì´ë²¤íŠ¸ê°€ Kafkaì— ì‹¤ì‹œê°„ìœ¼ë¡œ ìŒ“ì„
    - ë°°ì¹˜ê°€ ìƒˆë²½ 1ì‹œì— í•´ë‹¹ Kafka Topic ì½ì–´ì„œ **ì¼ì¼ ì •ì‚°/í†µê³„ ì§‘ê³„** ì‹¤í–‰
    - MQëŠ” ì‹¤ì‹œê°„ ë°˜ì˜, ë°°ì¹˜ëŠ” ì •í•©ì„± ë§ì¶¤
  - ìŠ¤ì¼€ì¤„ëŸ¬ -> ë°°ì¹˜ -> í
    - ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ë°°ì¹˜ ì‹¤í–‰ -> ê³ ê°ì—ê²Œ ë°œì†¡í•  ì¿ í° ëª©ë¡ ìƒì„±
    - ë°°ì¹˜ê°€ ê²°ê³¼ë¥¼ Kafka Topicì— ë„£ìŒ
    - MQ Consumerê°€ ì¿ í° ë°œì†¡ ì´ë²¤íŠ¸ë¥¼ ì½ì–´ì„œ ì´ë©”ì¼/SMS ì „ì†¡
  - MQ ì‹¤íŒ¨ -> DLQ -> ìŠ¤ì¼€ì¤„ëŸ¬+ë°°ì¹˜ ì¬ì²˜ë¦¬
    - MQ Consumerê°€ ì²˜ë¦¬ ì‹¤íŒ¨í•œ ë©”ì‹œì§€ -> DLQë¡œ ì´ë™
    - ìŠ¤ì¼€ì¤„ëŸ¬ê°€ 10ë¶„ë§ˆë‹¤ DLQ ì¬ì²˜ë¦¬ ë°°ì¹˜ë¥¼ ì‹¤í–‰ -> ì„±ê³µ ì‹œ ì •ìƒ íë¡œ ë‹¤ì‹œ Publish
- ê·¸ëŸ¬ë©´ ì™œ ì´ë ‡ê²Œ ì¡°í•©í• ê¹Œ?
  - **ì‹¤ì‹œê°„ì„± + ì•ˆì •ì„±**
    - MQ: ì‹¤ì‹œê°„ì„±
    - Batch: ìœ ì‹¤/ì¤‘ë³µ/ì •í•©ì„± ë¬¸ì œ ì œì–´
    - Scheduler: ì‹¤í–‰ ì‹œì /ì£¼ê¸° ì œì–´
    - MQë§Œ ì“°ë©´: ì‹¤ì‹œê°„ì€ ë˜ì§€ë§Œ, ëˆ„ë½/ì¤‘ë³µ ë°œìƒ ì‹œ íšŒë³µ ì–´ë ¤ì›€
    - Batchë§Œ ì“°ë©´: ì •í™•í•˜ì§€ë§Œ ì‹¤ì‹œê°„ì„±ì´ ë–¨ì–´ì§

---

## 3. ì°¸ê³ /ì¶”ê°€ ìë£Œ (References)
- ê°€ìƒ ë©´ì ‘ ì‚¬ë¡€ë¡œ ë°°ìš°ëŠ” ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ ì„¤ê³„ ê¸°ì´ˆ
- [Kafka ê³µì‹ ë¬¸ì„œ](https://kafka.apache.org/documentation/)
- [Confluent Blog â€“ A Guide to Consumer Offsets in Kafka](https://www.confluent.io/blog/guide-to-consumer-offsets)
- [Conduktor Docs â€“ Idempotent Kafka Producer](https://learn.conduktor.io/kafka/idempotent-kafka-producer)

---

## 4. ë‚´ì¼/ë‹¤ìŒì— ë³¼ ê²ƒ (Next Steps)
- Bookdam í”„ë¡œì íŠ¸ ì ìš© ê³ ë¯¼ + ì„¤ê³„

