# ğŸ“š Spring Persistence Context (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸)

---

## 1. ì£¼ì œ/í‚¤ì›Œë“œ
- JPAì—ì„œ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**(Persistence Context) ê°œë…ê³¼ ì—­í• ì— ëŒ€í•´ ê³µë¶€í•˜ì~ (Â´ï¼›Ğ´ï¼›)

---

## 2. í•µì‹¬ ìš”ì•½ (Summary)

### Persistence Context (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸)
- **ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ëŠ” 1ì°¨ ìºì‹œ ê°™ì€ ê³µê°„**
- JPAì—ì„œ `EntityManager`ê°€ DBë‘ ì§ì ‘ í†µì‹ í•˜ì§€ ì•Šê³ , ë¨¼ì € **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ë¥¼ ì˜¬ë ¤ì„œ ê´€ë¦¬**í•˜ë‹¤ê°€ íŠ¸ëœì­ì…˜ ì‹œì (Commit/Flush)ì— DBì— ë°˜ì˜í•¨
- ì¦‰, **ì—”í‹°í‹°ì˜ ìƒíƒœë¥¼ ì¶”ì í•˜ê³ , DB ë°˜ì˜ì„ ìµœì í™”í•˜ëŠ” ì¤‘ê°„ ê³„ì¸µ**
- ì—¬ê¸°ì„œ ì ê¹!
- JPA ë€?
  - ìë°” í‘œì¤€ ORM (Object Relational Mapping) ì¸í„°í˜ì´ìŠ¤
    - ORM: ê°ì²´(í´ë˜ìŠ¤)ì™€ ê´€ê³„í˜• DBì˜ í…Œì´ë¸”ì„ ë§¤í•‘í•´ì„œ SQLì„ ì§ì ‘ ì“°ì§€ ì•Šê³  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‹¤ë£¨ê²Œ í•´ì£¼ëŠ” ê¸°ìˆ 
  - JPA ìì²´ëŠ” êµ¬í˜„ì²´ê°€ ì—†ê³ , Hibernate, EclipseLink ê°™ì€ êµ¬í˜„ì²´ê°€ ì‹¤ì œë¡œ ë™ì‘
  - ê°œë°œìëŠ” persist(), find(), remove() ê°™ì€ ë©”ì„œë“œë¡œ ì—”í‹°í‹°ë¥¼ ë‹¤ë£¨ë©´, JPAê°€ ì•Œì•„ì„œ SQLì„ ìƒì„±í•˜ê³  ì‹¤í–‰! -> í¸ë¦¬
  - @Entity, @Id, @OneToMany ê°™ì€ ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ë§¤í•‘ ì„¤ì •
  - Spring Data JPA -> Repository ì¸í„°í˜ì´ìŠ¤ë§Œ ì •ì˜í•˜ë©´ CRUDê°€ ìë™ ì œê³µ
  - ì¥ì : ë°˜ë³µì ì¸ SQL ì‘ì„±ì´ ì¤„ì–´ë“¤ê³ , ê°ì²´ ì§€í–¥ì ì¸ ì½”ë“œë¡œ DBë¥¼ ë‹¤ë£° ìˆ˜ ìˆìŒ
  - ë‹¨ì : ë³µì¡í•œ SQL íŠœë‹ì´ë‚˜ DB íŠ¹ì • ê¸°ëŠ¥ í™œìš©ì´ ì–´ë ¤ì›€
    - í•´ê²°
      - Spring Data JPA + Querydsl ì´ìš©: ë™ì /ë³µì¡ ì¿¼ë¦¬ ì‘ì„± í¸ë¦¬
      - DB íŠ¹ì • ê¸°ëŠ¥ì— ëŒ€í•´ì„œëŠ” ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ ì‘ì„±

---

### ì—”í‹°í‹°ì˜ 4ê°€ì§€ ìƒíƒœ
1. **ë¹„ì˜ì†** (new / transient)
   - ì•„ì§ ì»¨í…ìŠ¤íŠ¸ì— ì˜¬ë¼ê°€ì§€ ì•Šì€ ìƒíƒœ (`new`ë¡œ ë§Œë“  ê°ì²´)
   ```java
   Member m = new Member("Yushi"); // ë¹„ì˜ì†
   ```

2. **ì˜ì†** (managed)
   - `persist()`ë¡œ ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ìƒíƒœ
   - ì´ì œë¶€í„° JPAê°€ ìƒíƒœ ë³€í™”ë¥¼ ì¶”ì  (Dirty Checking)
    ```java
    em.persist(m); // ì˜ì† ìƒíƒœ
    ```

3. **ì¤€ì˜ì†** (detached)
   - ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ëœ ìƒíƒœ (`em.detach()` / `em.clear()` ë“±)
   - ë³€ê²½í•´ë„ DBì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ

4. **ì‚­ì œ** (removed)
   - ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‚­ì œëœ ìƒíƒœ (`em.remove()` í˜¸ì¶œ)

---

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì—­í• 

1. **1ì°¨ ìºì‹œ**
   - ê°™ì€ ì—”í‹°í‹°ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¡°íšŒí•˜ë©´ DBì—ì„œ ë‹¤ì‹œ ì•ˆ ë¬¼ì–´ë³´ê³  **ìºì‹œì—ì„œ êº¼ë‚´ì¤Œ** -> ì„±ëŠ¥ ìµœì í™”

2. **ë™ì¼ì„± ë³´ì¥** (Identity Guarantee)
   - ê°™ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ê°™ì€ PKë¥¼ ê°€ì§„ ì—”í‹°í‹°ëŠ” **í•­ìƒ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤** ë°˜í™˜
    ```java
    Member m1 = em.find(Member.class, 1L);
    Member m2 = em.find(Member.class, 1L);
    System.out.println(m1 == m2); // true
    ```

3. **ì“°ê¸° ì§€ì—°** (Write-behind)
   - `persist()` í˜¸ì¶œ ì‹œ ë°”ë¡œ INSERT ì¿¼ë¦¬ ë‚ ë¦¬ì§€ ì•Šê³ , **SQL ì €ì¥ì†Œì— ìŒ“ì•„ë’€ë‹¤ê°€** íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ í•œêº¼ë²ˆì— DB ë°˜ì˜

4. **Dirty Checking** (ë³€ê²½ ê°ì§€)
   - ì—”í‹°í‹° ê°’ë§Œ ë°”ê¿”ë„, ìŠ¤ëƒ…ìƒ·ê³¼ ë¹„êµí•´ì„œ **UPDATE ì¿¼ë¦¬ ìë™ ìƒì„±**
   - ê°œë°œìê°€ `save()` ê°™ì€ ê±° ì•ˆ ë¶ˆëŸ¬ë„ ë¨

5. **Flush** (ë™ê¸°í™”)
   - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ê°’ê³¼ DBë¥¼ ë§ì¶”ëŠ” ì‹œì 
   - ë³´í†µ íŠ¸ëœì­ì…˜ **commit ì§ì „**ì— flushê°€ ìë™ í˜¸ì¶œë¨

---

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ @Transactional
- `@Transactional`ì´ ë¶™ì€ ë©”ì„œë“œ ì‹¤í–‰ ì‹œ
  - íŠ¸ëœì­ì…˜ ì‹œì‘ -> ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë„ ê°™ì´ ì‹œì‘
  - ì—”í‹°í‹° ë³€ê²½ì‚¬í•­ ì¶”ì 
  - commit ì‹œì ì— flush -> DBì— ë°˜ì˜
- ì¦‰, **íŠ¸ëœì­ì…˜ ë‹¨ìœ„ = ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‹¨ìœ„**

---

## 3. ì½”ë“œ ì˜ˆì‹œ

```java
@Transactional
public void updateUser(Long id) {
    Member member = em.find(Member.class, id); // 1ì°¨ ìºì‹œ or DB ì¡°íšŒ
    member.setName("ìƒˆë¡œìš´ ì´ë¦„"); // Dirty Checkingìœ¼ë¡œ ë³€ê²½ ê°ì§€
} 
// ë©”ì„œë“œ ì¢…ë£Œ ì‹œì  = commit -> flush ->  UPDATE ì¿¼ë¦¬ ì‹¤í–‰
```
- `setName()`ë§Œ í•´ë„ ìë™ìœ¼ë¡œ UPDATE ì¿¼ë¦¬ë¥¼ ë‚ ë¦¼!! (Dirty Checking)

---

## 4. ì°¸ê³ /ì¶”ê°€ ìë£Œ (References)

- [Spring Docs - JPA](https://docs.spring.io/spring-framework/reference/data-access/orm/jpa.html)
- [Hibernate Reference - Persistence Context](https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#pc-overview)

---

## 5. ë‚´ì¼/ë‹¤ìŒì— ë³¼ ê²ƒ (Next Steps)
- ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ íŒŒë³´ê¸°..... ì˜›ë‚ ì— ê³µë¶€ í–ˆì—ˆëŠ”ë° ê¸°ì–µì´ ì•ˆë‚œë‹¤ã…œã… 