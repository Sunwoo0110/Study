# ğŸ“š Spring JPA

---

## 1. ì£¼ì œ/í‚¤ì›Œë“œ
- JPA ì˜ ê°œë…, ë™ì‘ ì›ë¦¬, ì£¼ì˜ ì‚¬í•­ì— ëŒ€í•´ ê³µë¶€í•´ë³´ì~ (ã¤â€¢Ì€Ï‰â€¢Ì)ã¤

## ğŸ“‘ ëª©ì°¨

- [ğŸ“š Spring JPA](#-spring-jpa)
  - [1. ì£¼ì œ/í‚¤ì›Œë“œ](#1-ì£¼ì œí‚¤ì›Œë“œ)
  - [ğŸ“‘ ëª©ì°¨](#-ëª©ì°¨)
  - [2. í•µì‹¬ ìš”ì•½ (Summary)](#2-í•µì‹¬-ìš”ì•½-summary)
    - [JPA (Java Persistence API)](#jpa-java-persistence-api)
    - [Hibernate](#hibernate)
    - [Spring Data JPA](#spring-data-jpa)
    - [JPA ë™ì‘ ì›ë¦¬](#jpa-ë™ì‘-ì›ë¦¬)
      - [ì½”ë“œë¡œ íŒŒë³´ëŠ” JPA ë™ì‘](#ì½”ë“œë¡œ-íŒŒë³´ëŠ”-jpa-ë™ì‘)
      - [JPA ì‘ë™ ì›ë¦¬ + Spring @Transactional íë¦„ ì •ë¦¬](#jpa-ì‘ë™-ì›ë¦¬--spring-transactional-íë¦„-ì •ë¦¬)
    - [JPA ë¬¸ì œ: N+1 ë¬¸ì œ](#jpa-ë¬¸ì œ-n1-ë¬¸ì œ)
      - [N+1 ë¬¸ì œ ìƒí™© ì˜ˆì‹œ](#n1-ë¬¸ì œ-ìƒí™©-ì˜ˆì‹œ)
      - [í•´ê²° ë°©ë²•](#í•´ê²°-ë°©ë²•)
      - [Batch Fetch (`@BatchSize`, `hibernate.default_batch_fetch_size`)](#batch-fetch-batchsize-hibernatedefault_batch_fetch_size)
      - [DTO ì „ìš© ì¡°íšŒ](#dto-ì „ìš©-ì¡°íšŒ)
      - [`Fetch Join`](#fetch-join)
      - [`@EntityGraph`](#entitygraph)
    - [JPA ë¬¸ì œ: ë™ì‹œì„± ì œì–´](#jpa-ë¬¸ì œ-ë™ì‹œì„±-ì œì–´)
      - [ë‚™ê´€ì  ë½ (Optimistic Lock)](#ë‚™ê´€ì -ë½-optimistic-lock)
      - [ë¹„ê´€ì  ë½ (Pessimistic Lock)](#ë¹„ê´€ì -ë½-pessimistic-lock)
      - [ê²©ë¦¬ ìˆ˜ì¤€(Isolation)ê³¼ì˜ ê´€ê³„](#ê²©ë¦¬-ìˆ˜ì¤€isolationê³¼ì˜-ê´€ê³„)
    - [MyBatis vs JPA](#mybatis-vs-jpa)
    - [JPA ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ê³ ë ¤ ì‚¬í•­](#jpa-ì„±ëŠ¥-ìµœì í™”ë¥¼-ìœ„í•œ-ê³ ë ¤-ì‚¬í•­)
    - [ìì£¼ ë°œìƒí•˜ëŠ” ì‹¤ìˆ˜ + ì‹¤ì œ ë°œìƒí–ˆë˜ ë¬¸ì œë“¤ ì •ë¦¬](#ìì£¼-ë°œìƒí•˜ëŠ”-ì‹¤ìˆ˜--ì‹¤ì œ-ë°œìƒí–ˆë˜-ë¬¸ì œë“¤-ì •ë¦¬)
    - [ë” ê³ ë¯¼í•´ë³¼ ë¬¸ì œë“¤](#ë”-ê³ ë¯¼í•´ë³¼-ë¬¸ì œë“¤)
  - [3. ì°¸ê³ /ì¶”ê°€ ìë£Œ (References)](#3-ì°¸ê³ ì¶”ê°€-ìë£Œ-references)
  - [4. ë‚´ì¼/ë‹¤ìŒì— ë³¼ ê²ƒ (Next Steps)](#4-ë‚´ì¼ë‹¤ìŒì—-ë³¼-ê²ƒ-next-steps)

---

## 2. í•µì‹¬ ìš”ì•½ (Summary)

### JPA (Java Persistence API)
- ìë°”ì—ì„œ ORM(Object Relational Mapping) í‘œì¤€ ì¸í„°í˜ì´ìŠ¤
- **ìë°” ê°ì²´(Entity)ì™€ DB í…Œì´ë¸”ì„ ë§¤í•‘**í•´ì£¼ëŠ” ì—­í• 
- ```java
    // SQL ì§ì ‘ ì‘ì„± X
    User user = entityManager.find(User.class, 1L);
    ```
- ì´ë ‡ê²Œ ê°ì²´ ì¡°íšŒí•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œëŠ” SELECT * FROM user WHERE id=1 ì‹¤í–‰ë¨
- ì¦‰, SQL ëŒ€ì‹  ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥
- ì¥ì 
  - **ìƒì‚°ì„±**ì´ ë†’ì•„ì§
    - CRUD ì½”ë“œ ìë™í™” -> save(), findById() ë“± ê¸°ë³¸ ì œê³µ
    - SQL ì§ì ‘ ì‘ì„±í•  ì¼ì´ ì¤„ì–´ë“¦ -> ê°œë°œ ì†ë„ ë†’ì•„ì§
  - **ìœ ì§€ë³´ìˆ˜ì„±**
    - ì—”í‹°í‹°(í´ë˜ìŠ¤) ì¤‘ì‹¬ ì„¤ê³„ -> ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì£¼ë¡œ ì½”ë“œ ì‘ì„±
    - DB ë³€ê²½ ì‹œì—ë„ ì—”í‹°í‹°ë§Œ ìˆ˜ì •í•˜ë©´ ë¨ -> SQL ìˆ˜ì • ìµœì†Œí™”
  - **ê°ì²´ ì§€í–¥ì  ê°œë°œ**
    - ì—°ê´€ê´€ê³„ ë§¤í•‘(@OneToMany, @ManyToOne) ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰ í¸ë¦¬
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ + Dirty Checking ìœ¼ë¡œ ê°ì²´ ë³€ê²½ë§Œ í•´ë„ DB ë°˜ì˜
  - **ë¶€ê°€ê¸°ëŠ¥**
    - ìºì‹œ(1ì°¨ ìºì‹œ), ì§€ì—° ë¡œë”©(Lazy Loading), ë°°ì¹˜ ì²˜ë¦¬, Auditing ë“± ê¸°ë³¸ ê¸°ëŠ¥
- ë‹¨ì 
  - **ì„±ëŠ¥ ì´ìŠˆ**
    - N+1 ë¬¸ì œ, ë¶ˆí•„ìš”í•œ ì¿¼ë¦¬ ë°œìƒ ê°€ëŠ¥
    - ì˜ëª» ì“°ë©´ SQL íŠœë‹ë³´ë‹¤ ìƒí™©ì´ ë” ê¼¬ì¼ ìˆ˜ ìˆìŒ
  - **ì¶”ìƒí™”ì˜ í•œê³„**
    - ë³µì¡í•œ SQL(ì˜ˆ: í†µê³„, ë‹¤ì¤‘ ì¡°ì¸, ìœˆë„ìš° í•¨ìˆ˜)ì€ JPQLë¡œ í•œê³„ ì¡´ì¬
    - Native Query ì“°ëŠ” ìƒí™© ë°œìƒ ê°€ëŠ¥ -> DB ì¢…ì†ì„± ì¦ê°€
  - **ë””ë²„ê¹… ì–´ë ¤ì›€**
    - SQLì´ ìë™ ìƒì„±ë˜ë¯€ë¡œ, ì‹¤ì œë¡œ ì–´ë–¤ ì¿¼ë¦¬ê°€ ë‚ ì•„ê°€ëŠ”ì§€ ì¶”ì  í•„ìš” (Hibernate show_sql ë“±)
    - ë¬¸ì œ ìƒê²¼ì„ ë•Œ JPA ë‚´ë¶€ ë™ì‘ê¹Œì§€ íŒŒì•…í•´ì•¼ í•¨
  - **ë™ì‹œì„± ì²˜ë¦¬**
    - Optimistic / Pessimistic Lock ë”°ë¡œ ê³ ë ¤í•´ì•¼ í•¨
    - ë‹¨ìˆœ íŠ¸ëœì­ì…˜ë§Œìœ¼ë¡œëŠ” ë™ì‹œì„± ì´ìŠˆ í•´ê²° ì–´ë ¤ì›€

### Hibernate
- JPA êµ¬í˜„ì²´(Implementation) ì¤‘ í•˜ë‚˜
- JPAëŠ” ì¸í„°í˜ì´ìŠ¤ì´ë¯€ë¡œ ì§ì ‘ ì“¸ ìˆ˜ ì—†ìŒ -> Hibernateê°€ ì‹¤ì œ ë™ì‘(SQL ìƒì„±/ìºì‹œ/ë”í‹°ì²´í‚¹) ì œê³µ
- Springì—ì„œëŠ” ê±°ì˜ Hibernateë¥¼ JPA êµ¬í˜„ì²´ë¡œ ì‚¬ìš©

### Spring Data JPA
- Springì—ì„œ JPAë¥¼ ë” ì‰½ê²Œ ì“°ê²Œ í•´ì£¼ëŠ” ëª¨ë“ˆ
- ë°˜ë³µì ì¸ ì½”ë“œ (DAO, Repository) ì¤„ì—¬ì¤Œ
- ```java
    public interface UserRepository extends JpaRepository<User, Long> {
        List<User> findByEmail(String email);
    }
    ```
- ìœ„ ì½”ë“œ í•œ ì¤„ì´ë©´ -> SELECT * FROM user WHERE email = ? ìë™ ì‹¤í–‰
- ì´ë¥¼ í†µí•´ ê°œë°œìëŠ” ì§ì ‘ ì¿¼ë¦¬ ì•ˆ ì§œê³ , ë©”ì„œë“œ ë„¤ì´ë° ê·œì¹™ë§Œ ì§€ì¼œë„ SQL ì‹¤í–‰ë¨!

---

### JPA ë™ì‘ ì›ë¦¬
- EntityManagerë¡œ ëª…ë ¹ì„ ë°›ìŒ -> ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(PC)ì—ì„œ ìºì‹±/ë³€ê²½ê°ì§€/ì“°ê¸°ì§€ì—° ê´€ë¦¬ -> íŠ¸ëœì­ì…˜ commit ì‹œ flush -> SQL ì‹¤í–‰

#### ì½”ë“œë¡œ íŒŒë³´ëŠ” JPA ë™ì‘
- `em.persist(entity)`
  - ì—”í‹°í‹°ë¥¼ PC(1ì°¨ ìºì‹œ)ì— ì €ì¥
  - SQL ì•ˆ ë³´ëƒ„ -> INSERTëŠ” **ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œ**ì— ìŒ“ì„
  - ```java
        em.persist(new User("sunwoo")); 
        // -> 1ì°¨ ìºì‹œ ë“±ë¡ + ì“°ê¸° ì§€ì—° ì €ì¥ì†Œì— INSERT ì¤€ë¹„
    ```

- `em.find(User.class, id)`
  - PC(1ì°¨ ìºì‹œ) ë¨¼ì € í™•ì¸
  - ìˆìœ¼ë©´ DB ì¡°íšŒ ì•ˆí•˜ê³  ë°”ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜ (**ë™ì¼ì„± ë³´ì¥**)
  - ì—†ìœ¼ë©´ DB ì¡°íšŒ í›„ PCì— ì €ì¥í•˜ê³  ë°˜í™˜
  - ```java
        User u1 = em.find(User.class, 1L); // DB ì¡°íšŒ -> PCì— ìºì‹±
        User u2 = em.find(User.class, 1L); // 1ì°¨ ìºì‹œ íˆíŠ¸, ê°™ì€ ê°ì²´ ë°˜í™˜
        System.out.println(u1 == u2); // true
    ```

- `entity.setName("new")`
  - ì—”í‹°í‹°ëŠ” ë‹¨ìˆœíˆ ìë°” ê°ì²´ë¼ì„œ setter í˜¸ì¶œ ì‹œ ê°’ë§Œ ë°”ë€œ
  - ê·¼ë° PCëŠ” ì²˜ìŒ ì €ì¥ ì‹œ ìŠ¤ëƒ…ìƒ·ì„ ë³µì‚¬í•´ë‘ 
  - flush ì‹œì ì— ìŠ¤ëƒ…ìƒ· vs í˜„ì¬ê°’ ë¹„êµ -> ë‹¤ë¥´ë©´ UPDATE SQL ìƒì„±
  - ì´ê²Œ **Dirty Checking** (ë³€ê²½ ê°ì§€)

- `transaction.commit()`
  - ì»¤ë°‹ ì‹œì ì— JPAê°€ ìë™ìœ¼ë¡œ `flush()` í˜¸ì¶œ
    - ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œì˜ INSERT/UPDATE/DELETE í•œêº¼ë²ˆì— DBë¡œ ì „ì†¡
    - íŠ¸ëœì­ì…˜ commit

#### JPA ì‘ë™ ì›ë¦¬ + Spring @Transactional íë¦„ ì •ë¦¬

```java
@Transactional
public void run(EntityManager em) {
    // 1. ì˜ì†í™”
    User u1 = new User("sunwoo");
    em.persist(u1); 
    // -> 1ì°¨ ìºì‹œ + ì“°ê¸° ì§€ì—° ì €ì¥ì†Œì— INSERT ëŒ€ê¸°

    // 2. ì¡°íšŒ
    User u2 = em.find(User.class, u1.getId()); 
    // -> ê°™ì€ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ 1ì°¨ ìºì‹œì—ì„œ ë°”ë¡œ ë°˜í™˜

    // 3. ë³€ê²½
    u1.setName("newSunwoo"); 
    // -> ìŠ¤ëƒ…ìƒ·ê³¼ ë¹„êµ ì˜ˆì • (Dirty checking ì¤€ë¹„)
} 
// 4. íŠ¸ëœì­ì…˜ ì¢…ë£Œ ì‹œì 
// flush: INSERT, UPDATE(ë”í‹° ì²´íŒ…ìœ¼ë¡œ ìƒì„±) SQL ì „ì†¡
// commit: DB ë°˜ì˜
```

- **ë™ì¼ì„± ë³´ì¥**: ê°™ì€ PKë©´ ê°™ì€ ê°ì²´(`==`) ë°˜í™˜
- **DB Hit ìµœì†Œí™”**: ê°™ì€ íŠ¸ëœì­ì…˜ì—ì„œ ë°˜ë³µ ì¡°íšŒ ì‹œ DB ì¬ì¡°íšŒ ì•ˆ í•¨
- **ì“°ê¸° ì§€ì—°**: ì„±ëŠ¥ ìµœì í™”, batch insert ê°€ëŠ¥
- **ë”í‹°ì²´í‚¹**: `save()` ê°™ì€ ëª…ì‹œì  í˜¸ì¶œ ì—†ì´ ë³€ê²½ ê°ì§€ë¡œ ìë™ UPDATE

---

### JPA ë¬¸ì œ: N+1 ë¬¸ì œ
- JPAì—ì„œ ì—”í‹°í‹°ëŠ” ë³´í†µ ì—°ê´€ê´€ê³„(`@ManyToOne`, `@OneToMany`)ë¥¼ ê°€ì§
- ì´ ì—°ê´€ ì—”í‹°í‹°ë¥¼ ì–¸ì œ ë¡œë”©í• ì§€ê°€ **LAZY** / **EAGER**
- **LAZY** (ì§€ì—° ë¡œë”©)
  - í•„ìš”í•  ë•Œ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹
  - ì‹¤ì œ SQLì„ ë°”ë¡œ ì•ˆ ë‚ ë¦¬ê³  í”„ë¡ì‹œ ê°ì²´ë¥¼ ë‘ì—ˆë‹¤ê°€ getter í˜¸ì¶œ ì‹œ ì¿¼ë¦¬ ì‹¤í–‰
  - ë³´í†µ ì§€ì—° ë¡œë”© ì‚¬ìš©(ì•ˆ ê·¸ëŸ¬ë©´ í„°ì§..)
- **EAGER** (ì¦‰ì‹œ ë¡œë”©)
  - ì£¼ í…Œì´ë¸” ë¶ˆëŸ¬ì˜¬ ë•Œ ì—°ê´€ ê´€ê³„ ë°ì´í„°ë„ ë‹¤ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹
  - ì—¬ëŸ¬ ê´€ê³„ê°€ ê²¹ì¹˜ë©´ ì¿¼ë¦¬ ì˜ˆì¸¡ ì–´ë ¤ì›€ -> N+1 ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
- ì‚¬ìš© ë°©ë²•
  - ManyToOne, OneToOne: fetch join (row ìˆ˜ ì•ˆ ëŠ˜ì–´ë‚˜ì„œ ì•ˆì „)
  - OneToMany, ManyToMany: batch fetch (row ì¤‘ë³µ/í˜ì´ì§• ë¬¸ì œ ë•Œë¬¸ì—)
  - ë³µì¡ í™”ë©´: DTO ì¡°íšŒ (ì²˜ìŒë¶€í„° í™”ë©´ì— ë§ëŠ” ë°ì´í„° ë½‘ê¸°)

#### N+1 ë¬¸ì œ ìƒí™© ì˜ˆì‹œ
- ê²Œì‹œê¸€(Post)ê³¼ ì‘ì„±ì(User) ê´€ê³„ (`Post N : 1 User`)

```java
List<Post> posts = postRepo.findAll();   // ì—¬ê¸°ì„œ 1ë²ˆ ì¿¼ë¦¬
for (Post p : posts) {
    System.out.println(p.getAuthor().getName()); // User ë¡œë”©í•  ë•Œ Në²ˆ ì¿¼ë¦¬
}
```
- ì²« ì¤„: `post` ì „ì²´ ì¡°íšŒ
- ë£¨í”„ ëŒë©° `getAuthor()` í˜¸ì¶œ -> ë§¤ë²ˆ `select * from user where id = ?` ì‹¤í–‰ -> **Në²ˆ ì¿¼ë¦¬**
- ì´ **1+N ì¿¼ë¦¬** ë°œìƒ -> N+1 ë¬¸ì œ
- ë°ì´í„° ë§ì•„ì§ˆìˆ˜ë¡ SELECT ë§ì´ ë°œìƒ (1000ê°œ postë©´? 1001ë²ˆ ì¿¼ë¦¬)
- ì¦‰, ì»¬ë ‰ì…˜ ìˆ˜(N)ì— ë¹„ë¡€í•´ì„œ ì¶”ê°€ ì¿¼ë¦¬ê°€ Në²ˆ ë” ë‚˜ê°!

#### í•´ê²° ë°©ë²•

#### Batch Fetch (`@BatchSize`, `hibernate.default_batch_fetch_size`)
- JPAê°€ LAZY í”„ë¡ì‹œë¥¼ í•œ ë²ˆì— IN ì¿¼ë¦¬ë¡œ ë¬¶ì–´ ë¡œë”©
- ```java
    @OneToMany(mappedBy = "post")
    @BatchSize(size = 100)
    private List<Comment> comments;
    ```
- ë°°ì¹˜ ì‚¬ì´ì¦ˆë§Œí¼ ë­‰íƒ±ì´ë¡œ ì¿¼ë¦¬ -> IN ìœ¼ë¡œ ë¬¶ì–´ì„œ ì¡°íšŒ
- ì¥ì : ë‹¤ëŒ€ì¼/ì»¬ë ‰ì…˜ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥, ì‹¤ë¬´ì—ì„œ ìì£¼ ì”€
- ë‹¨ì : fetch joinë§Œí¼ ê¹”ë”í•˜ì§„ ì•Šê³ , SQL IN ì‚¬ì´ì¦ˆ í•œê³„ ê³ ë ¤

#### DTO ì „ìš© ì¡°íšŒ
- ì²˜ìŒë¶€í„° í•„ìš”í•œ ë°ì´í„°ë§Œ SELECT (JPQL, QueryDSL ë“±ìœ¼ë¡œ DTO ì§ì ‘ ë§¤í•‘)
- ```java
    @Query("select new com.example.PostDto(p.id, p.title, u.name) " +
        "from Post p join p.author u")
    List<PostDto> findPostDtos();
    ```
- ì¥ì : ìµœì í™” ìµœê³ , N+1 ë¬¸ì œ ë°œìƒ ì•ˆí•¨
- ë‹¨ì : í™”ë©´ ì¢…ì†ì ì¸ ì½”ë“œ ë§ì•„ì§(UI ìš”êµ¬ì‚¬í•­ì´ ë³€í•  ë•Œë§ˆë‹¤ DTO + JPQL/QueryDSL ì½”ë“œë¥¼ ë³€ê²½í•´ì•¼í•¨)
  
#### `Fetch Join`
- JPQLì—ì„œ JOIN + FETCHë¡œ í•œ ë°©ì— ê°€ì ¸ì˜¤ê¸°
- ```java
    @Query("select p from Post p join fetch p.author")
    List<Post> findAllWithAuthor();
    ```
- ì¥ì : ë‹¨ìˆœ
- ë‹¨ì : ì»¬ë ‰ì…˜(fetch join) + í˜ì´ì§• ë¶ˆê°€ -> ë©”ëª¨ë¦¬ í„°ì§

#### `@EntityGraph`
- Spring Data JPA ê¸°ëŠ¥, ë©”ì„œë“œ í˜¸ì¶œ ì‹œ ìë™ fetch join ì ìš©
- ```java
    @EntityGraph(attributePaths = {"author"})
    List<Post> findByStatus(Status status);
    ```
- ì¥ì : ì½”ë“œ ê°„ê²°, ì¿¼ë¦¬ ìë™ ìƒì„±
- ë‹¨ì : ë³µì¡í•œ fetch ì „ëµ ì¡°í•©ì€ ì–´ë ¤ì›€

---

### JPA ë¬¸ì œ: ë™ì‹œì„± ì œì–´
- JPAëŠ” ì—”í‹°í‹°ë¥¼ ë©”ëª¨ë¦¬(ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸) ì•ˆì—ì„œ ê´€ë¦¬í•˜ë‹¤ê°€ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— í•œ ë²ˆì— DBì— ë°˜ì˜(flush) í•¨
- ê·¸ëŸ°ë° ë§Œì•½ ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ê°™ì€ ì—”í‹°í‹°ì— ì ‘ê·¼í•œë‹¤ë©´??
- **ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ê°™ì€ ì—”í‹°í‹°ë¥¼ ë™ì‹œì— ì½ê³ , ìˆ˜ì •í•˜ê³ , ì»¤ë°‹**í•˜ë©° ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆìŒ!!
- ê°€ì¥ í”í•œ ë¬¸ì œ -> **Lost Update**(ê°±ì‹  ì†ì‹¤)
  - ë‘ ì‚¬ìš©ìê°€ ê°™ì€ ë°ì´í„°ë¥¼ ì½ìŒ -> ê°ê° ìˆ˜ì • -> ë§ˆì§€ë§‰ì— ì»¤ë°‹í•œ ê°’ë§Œ ë‚¨ìŒ
- JPAëŠ” ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ë¡œëŠ” Lost Updateë¥¼ ë§‰ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì—, **ì¶”ê°€ë¡œ Optimistic/Pessimistic Lock**ì„ ê±¸ì–´ì•¼ í•¨

#### ë‚™ê´€ì  ë½ (Optimistic Lock)
- **ë™ì‹œì— ì¶©ëŒ ë‚  ì¼ì€ ë“œë¬¼ë‹¤~** -> ì¼ë‹¨ ë‹¤ ì½ê³  ì“°ê²Œ ë‘ê³ , **ì»¤ë°‹ ì‹œì ì— ì¶©ëŒ ê°ì§€**
- ë°©ë²•: `@Version` í•„ë“œ ì‚¬ìš© (ìˆ«ì or íƒ€ì„ìŠ¤íƒ¬í”„)
- ì—”í‹°í‹°ì— `@Version` í•„ë“œë¥¼ ë‘  (int, long, timestamp ë“± ê°€ëŠ¥)
- ë°ì´í„°ë¥¼ ì½ì–´ì˜¬ ë•Œ **í˜„ì¬ ë²„ì „ ê°’**ì„ ê°™ì´ ë“¤ê³  ì˜´
- ìˆ˜ì • í›„ ì»¤ë°‹ ì‹œ `where id=? and version=?` ì¡°ê±´ìœ¼ë¡œ update ì‹¤í–‰
  - ìˆ˜ì •ì´ ì„±ê³µí•˜ë©´ version +1
  - ì‹¤íŒ¨í•˜ë©´(ì—…ë°ì´íŠ¸ëœ row ì—†ìŒ) -> ëˆ„êµ°ê°€ ë¨¼ì € ê³ ì³¤ë‹¤ëŠ” ëœ» -> OptimisticLockException
- ì¥ì 
  - DB ë½ì„ ê±¸ì§€ ì•Šì•„ ì„±ëŠ¥, ë™ì‹œì„± ì²˜ë¦¬ëŸ‰ì´ ì¢‹ìŒ
  - ì¶©ëŒ ë¹ˆë„ê°€ ë‚®ì€ ì‹œë‚˜ë¦¬ì˜¤(ì˜ˆ: ê²Œì‹œê¸€ ìˆ˜ì •, ìœ ì € í”„ë¡œí•„ ë³€ê²½)ì— ì í•©
- ë‹¨ì 
  - ì¶©ëŒ ì‹œ ì˜ˆì™¸ -> ë°˜ë“œì‹œ ë¹„ì¦ˆë‹ˆìŠ¤ ë ˆë²¨ì—ì„œ ì¬ì‹œë„ ì „ëµ í•„ìš”

#### ë¹„ê´€ì  ë½ (Pessimistic Lock)
- **ì–´ì°¨í”¼ ì¶©ëŒ ìì£¼ ë‚  ê±°ë©´ ë¯¸ë¦¬ ë§‰ì~~** -> **DB ì°¨ì›ì—ì„œ Lock**
- JPAì—ì„œëŠ” `@Lock` ì–´ë…¸í…Œì´ì…˜ì´ë‚˜ `EntityManager.lock()`ìœ¼ë¡œ ì‚¬ìš©
- SQL `select ... for update` ì‹¤í–‰ -> ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ í•´ë‹¹ row ì ‘ê·¼ ì‹œ ë§‰ìŒ
- ì¥ì 
  - ì¶©ëŒì´ ë§ì•„ë„ ì•ˆì „
  - Lost Update ë°©ì§€ í™•ì‹¤
- ë‹¨ì 
  - ë°ë“œë½, íƒ€ì„ì•„ì›ƒ ë°œìƒ ìœ„í—˜
  - ë½ ì¡ê³  ìˆëŠ” ë™ì•ˆ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ëŒ€ê¸° -> ë™ì‹œì„± ì²˜ë¦¬ëŸ‰ ë‚®ì•„ì§
  - ë”°ë¼ì„œ **íŠ¸ëœì­ì…˜ì„ ì§§ê²Œ ìœ ì§€**í•´ì•¼ í•¨!

#### ê²©ë¦¬ ìˆ˜ì¤€(Isolation)ê³¼ì˜ ê´€ê³„
- DBì˜ **íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€**ë„ ë™ì‹œì„±ì— ì˜í–¥ì„ ë¯¸ì¹¨

| Isolation Level     | íŠ¹ì§•                                       | JPAì—ì„œ ë³´ì™„ ë°©ë²•   |
| ------------------- | ---------------------------------------- | ------------- |
| Read Committed (ê¸°ë³¸) | Dirty Read ë°©ì§€, í•˜ì§€ë§Œ **Lost Update ë°œìƒ ê°€ëŠ¥** | ë‚™ê´€ì  ë½ìœ¼ë¡œ ë³´ì™„  |
| Repeatable Read     | ê°™ì€ rowëŠ” í•­ìƒ ê°™ì€ ê°’ ë³´ì¥, ê·¸ëŸ¬ë‚˜ ê°±ì‹  ì¶©ëŒì€ ì—¬ì „íˆ ë°œìƒ    | ë‚™ê´€ë½ or ë¹„ê´€ë½ í•„ìš” |
| Serializable        | ëª¨ë“  ì¶©ëŒ ë°©ì§€ (ì™„ë²½), ëŒ€ì‹  ì„±ëŠ¥ ë§¤ìš° ì•ˆì¢‹ìŒ                | ì‹¤ë¬´ì—ì„œ ê±°ì˜ ì•ˆ ì”€   |

---

### MyBatis vs JPA 

| í•­ëª©       | JPA(Hibernate)         | MyBatis            |
| -------- | ---------------------- | ------------------ |
| ê°œë°œ ì†ë„    | CRUD/í˜ì´ì§• ë¹ ë¦„            | SQL ì§ì ‘ -> ì´ˆë°˜ ëŠë¦¼   |
| ìœ ì§€ë³´ìˆ˜     | ê°ì²´ ëª¨ë¸ ì¤‘ì‹¬, ë³€ê²½ì— ê°•í•¨       | SQLì´ ëª…í™•, íŠœë‹/ë””ë²„ê¹… ì§ê´€ |
| ì„±ëŠ¥ ì œì–´    | ì¶”ìƒí™” ë†’ì•„ ì˜ë„ì¹˜ ì•Šì€ ì¿¼ë¦¬ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ | ì¿¼ë¦¬ 100% í†µì œ         |
| ë³µì¡ ì¿¼ë¦¬/ì§‘ê³„ | DTO/ë„¤ì´í‹°ë¸Œ í•„ìš”            | ë³µì¡ ì¡°ì¸/ë¦¬í¬íŠ¸ì— ìš©ì´  |
| í•™ìŠµ ê³¡ì„     | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸/fetch ì´í•´ í•„ìš”      | SQL ì•Œë©´ ë°”ë¡œ          |
| ëŒ€ê·œëª¨ ëª©ë¡   | DTO ì¡°íšŒ ì„¤ê³„ í•„ìš”           | í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ê¹”ë”íˆ        |

- íŠ¸ëœì­ì…˜ì´ ì¤‘ìš”í•˜ê³  CRUD ì¤‘ì‹¬ -> **JPA**
- ë¦¬í¬íŠ¸/ì§‘ê³„/íŠœë‹ ì¤‘ì‹¬, SQLì´ ì¤‘ìš” -> **MyBatis**
- ê°™ì´ ì“°ê¸°ë„ í•¨

---

### JPA ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ê³ ë ¤ ì‚¬í•­
- **N+1 ë¬¸ì œ ê³ ë ¤**
  - ì‹¤í–‰ë˜ëŠ” SQLì„ ê¼­ ë¡œê¹…í•˜ê±°ë‚˜ í…ŒìŠ¤íŠ¸ì—ì„œ ì¬í˜„í•´ë´ì•¼ í•¨
  - ë°œê²¬ë˜ë©´ fetch join / EntityGraph / ë°°ì¹˜ ë¡œ ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì´ê¸°!
- **ë°°ì¹˜ INSERT/UPDATE**
  - `Hibernate jdbc.batch_size`ì™€ `order_inserts/updates=tru`eë¥¼ ì¼œë©´ ì—¬ëŸ¬ INSERT/UPDATEë¥¼ ë¬¶ì–´ì„œ ë‚ ë¦¼ -> ë„¤íŠ¸ì›Œí¬ round trip ì¤„ì–´ ì„±ëŠ¥ í¬ê²Œ ê°œì„ !
  - Round trip: í•œ ë²ˆ DBì— ê°”ë‹¤ ì˜¤ëŠ” ì™•ë³µ
- **DTO ì¡°íšŒ**
  - ëª©ë¡ í™”ë©´ì´ë‚˜ ë¦¬ìŠ¤íŠ¸+ìƒì„¸ ê°™ì´ ì „ì†¡ëŸ‰ì´ ë§ì€ APIëŠ” ì—”í‹°í‹° ì „ì²´ ë¶ˆëŸ¬ì˜¤ì§€ ë§ê³  DTOë¡œ í•„ìš”í•œ í•„ë“œë§Œ select
  - SQL/ë„¤íŠ¸ì›Œí¬/ì§ë ¬í™” ë¹„ìš© ì ˆì•½
- **OSIV OFF**
  - Open Session In View ë„ê³ , ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ **í•„ìš”í•œ ì—°ê´€ê´€ê³„ê¹Œì§€ ë¯¸ë¦¬ ë¡œë”© í›„ DTOë¡œ ë°˜í™˜**
  - Open Session In View: ì„œë¹„ìŠ¤/íŠ¸ëœì­ì…˜ ëë‚˜ê³ ë„ ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ë·°(JSP, JSON ì§ë ¬í™” ë“±) ì—ì„œ LAZY í•„ë“œë¥¼ ì ‘ê·¼ ê°€ëŠ¥ë„ë¡ í•¨
  - LazyInitializationException ë°©ì§€ + íŠ¸ëœì­ì…˜ ë²”ìœ„ ëª…í™•
- **ë²Œí¬ ì—°ì‚° í›„ PC ì •ë¦¬**
  - `@Modifying(clearAutomatically=true)` ë˜ëŠ” `em.clear()` í˜¸ì¶œ
  - ë²Œí¬ ì—°ì‚°ì€ 1ì°¨ ìºì‹œ ë¬´ì‹œí•˜ê¸° ë•Œë¬¸ì—, PCì™€ DB ë°ì´í„°ê°€ ë¶ˆì¼ì¹˜í•˜ëŠ” ë¬¸ì œë¥¼ ë§‰ì•„ì•¼ í•¨
  - DBëŠ” ìµœì‹  ìƒíƒœì¸ë° PC ì•ˆì˜ ì—”í‹°í‹°ëŠ” ì˜›ë‚  ê°’ ê·¸ëŒ€ë¡œ ë‚¨ì•„ ìˆìŒ
  - ì´í›„ ë™ì¼ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ DB ê°’ì´ ì•„ë‹ˆë¼ 1ì°¨ ìºì‹œì— ìˆë˜ êµ¬ë²„ì „ì´ ë°˜í™˜ë˜ëŠ” ë¬¸ì œ!
- **ì¸ë±ìŠ¤ ì„¤ê³„**
  - ì¡°íšŒ/ì •ë ¬/ì¡°ì¸ í‚¤ì— ë§ëŠ” ë³µí•© ì¸ë±ìŠ¤ ê¼­ ê³ ë ¤
  - DB ì„±ëŠ¥ íŠœë‹ì˜ ì ˆë°˜ì€ ì¸ë±ìŠ¤ ì„¤ê³„ë¼ê³  í•  ì •ë„... JPAë§Œ íŠœë‹í•´ë„ ì¸ë±ìŠ¤ ì—†ìœ¼ë©´ ë¬´ì˜ë¯¸
- **ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜**
  - `@Transactional(readOnly = true)`ë¥¼ ì“°ë©´ flush/ë”í‹°ì²´í‚¹ì´ ë¹„í™œì„±í™”
  - ì„±ëŠ¥ ìµœì í™” + DB ë“œë¼ì´ë²„ì— ì½ê¸° ì „ìš© íŒíŠ¸ë„ ì „ë‹¬ ê°€ëŠ¥

---

### ìì£¼ ë°œìƒí•˜ëŠ” ì‹¤ìˆ˜ + ì‹¤ì œ ë°œìƒí–ˆë˜ ë¬¸ì œë“¤ ì •ë¦¬
- **LazyInitializationException**: íŠ¸ëœì­ì…˜ ë°–ì—ì„œ LAZY ì ‘ê·¼
  - OSIV OFFë¼ë©´ **ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ë¯¸ë¦¬ ë¡œë”©(fetch/EntityGraph)** í›„ DTOë¡œ ë°˜í™˜
- **N+1 í­íƒ„**: EAGER/ë¬´ë¶„ë³„í•œ LAZY ì ‘ê·¼
  - Batch Fetch, DTO ì¡°íšŒ ë“±
- **save()ë¡œ ì—…ë°ì´íŠ¸ ë‚¨ë°œ**: merge ê²½ë¡œë¡œ ì›ì¹˜ ì•ŠëŠ” UPDATE
  - Spring Data JPAì˜ save()ëŠ” **ìƒˆë¡œ ì €ì¥**(persist)ë„ í•˜ê³  **ë³‘í•©**(merge)ë„ í•¨
  - í•­ìƒ **ì¡°íšŒ(ì˜ì†í™”) -> ë³€ê²½(ë”í‹°ì²´í‚¹) -> ì»¤ë°‹**
- **equals/hashCode**ë¥¼ IDë¡œ ìƒì„± ì „ë¶€í„° ì‚¬ìš©: ID nullì¸ ìƒíƒœë¡œ ì¡°íšŒ ì‹œ ë¬¸ì œ
  - **ë¶ˆë³€ ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤**(ì´ë©”ì¼ ë“±) ì‚¬ìš©
- **ManyToMany**: ì¤‘ê°„ í…Œì´ë¸” ìˆ¨ê¹€
  - **ì¤‘ê°„ ì—°ê²° ì—”í‹°í‹°**ë¥¼ ì‚¬ìš©í•´ì•¼ í™•ì¥ ê°€ëŠ¥
- **DDL ìë™ ë°˜ì˜(prod)**: `ddl-auto`ëŠ” ê°œë°œìš©
  - ìš´ì˜ì€ **Flyway/Liquibase**

---

### ë” ê³ ë¯¼í•´ë³¼ ë¬¸ì œë“¤
- **íŠ¸ëœì­ì…˜ ê²½ê³„**
  - í•­ìƒ ë§í•˜ì§€ë§Œ íŠ¸ëœì­ì…˜ì€ ìµœì†Œ ë²”ìœ„ë¡œ!
  - ì¡°íšŒ+ì™¸ë¶€ API+ì €ì¥ ì²˜ëŸ¼ í•œë²ˆì— ë§ì€ ì‘ì—…ì€ í•˜ì§€ ë§ì~
- **API ì‘ë‹µ ëª¨ë¸**
  - **ì—”í‹°í‹° ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€**, DTOë¡œ ë°˜í™˜
- **Aggregate ì„¤ê³„**
  - ë™ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì¼ ê°ì²´ ë²”ìœ„ ì •ì˜ -> Cascade/orphanRemoval ê¸°ì¤€
  - Aggregate: ë„ë©”ì¸ ëª¨ë¸ì—ì„œì˜ ì¼ê´€ì„± ê²½ê³„
  - Transaction: DBì—ì„œì˜ ì¼ê´€ì„± ê²½ê³„
  - íŠ¸ëœì­ì…˜ ë²”ìœ„ = Aggregate ë²”ìœ„ ë¡œ ì„¤ê³„
- **ë°ì´í„° ì •í•©ì„±**
  - ë‚™ê´€ë½ ì¬ì‹œë„/Unique Key/Upsert/ë©±ë“± í‚¤ ë“±ë“±
- **ì†Œí”„íŠ¸ ì‚­ì œ**
  - `deleted_at` ì»¬ëŸ¼

---

## 3. ì°¸ê³ /ì¶”ê°€ ìë£Œ (References)

- [Hibernate](https://docs.jboss.org/hibernate/orm/7.1/repositories/html_single/Hibernate_Data_Repositories.html)
- [Spring Data JPA](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [Hibernate Performance Tuning â€” Secrets To Lightning-Fast Database Access](https://medium.com/@noel.benji/hibernate-performance-tuning-secrets-to-lightning-fast-database-access-4456124c80b4)
- [Vlad Mihalcea Blog - High-Performance Java Persistence](https://vladmihalcea.com/tutorials/hibernate/)
- [JPA Locking (Baeldung)](https://www.baeldung.com/jpa-optimistic-locking)

---

## 4. ë‚´ì¼/ë‹¤ìŒì— ë³¼ ê²ƒ (Next Steps)
- DB ì¸ë±ìŠ¤... 
